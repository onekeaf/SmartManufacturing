# 智能制造系统架构设计文档

## 📋 目录
- [系统概述](#系统概述)
- [系统架构图](#系统架构图)
- [微服务拆分设计](#微服务拆分设计)
- [技术选型](#技术选型)
- [服务调用关系](#服务调用关系)
- [数据库设计](#数据库设计)
- [部署架构](#部署架构)

---

## 系统概述

### 项目背景
本项目是为某大型汽车制造企业设计的智能制造微服务管理平台，采用微服务架构实现从订单接收到整车下线的全流程数字化管理。

### 核心目标
-  支持多车型混线生产
-  实时监控生产设备状态
-  精准管控零部件库存
-  严格把控产品质量
-  实现生产过程全链路追溯
-  保证核心业务高可用性

---

## 系统架构图

### 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                          客户端/浏览器                            │
└────────────────────────────┬────────────────────────────────────┘
                             │ HTTP/HTTPS
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    API Gateway (8080)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  路由转发    │  │  负载均衡    │  │  限流熔断    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└────────┬────────┬────────┬────────┬────────┬────────────────────┘
         │        │        │        │        │
    ┌────▼───┐┌──▼───┐┌───▼──┐┌───▼───┐┌──▼────┐
    │ Order  ││Prod  ││Equip ││Invent ││Quality│
    │Service ││Svc   ││Svc   ││Svc    ││Service│
    │ 8081   ││8082  ││8083  ││8084   ││8085   │
    └────┬───┘└──┬───┘└───┬──┘└───┬───┘└──┬────┘
         │       │         │       │       │
    ┌────▼───────▼─────────▼───────▼───────▼────┐
    │          Nacos 注册中心 (8848)              │
    │  ┌──────────────┐  ┌──────────────┐       │
    │  │  服务注册    │  │  配置管理    │       │
    │  └──────────────┘  └──────────────┘       │
    └─────────────────────────────────────────────┘
         │       │         │       │       │
    ┌────▼───┐┌──▼───┐┌───▼──┐┌───▼───┐┌──▼────┐
    │ MySQL  ││MySQL ││MySQL ││MySQL  ││MySQL  │
    │ Order  ││Prod  ││Equip ││Invent ││Quality│
    │  DB    ││ DB   ││ DB   ││ DB    ││  DB   │
    └────────┘└──────┘└──────┘└───────┘└───────┘

┌─────────────────────────────────────────────────────────────────┐
│                    监控与追踪组件                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  Sentinel    │  │  SkyWalking  │  │  Nacos       │          │
│  │  熔断监控    │  │  链路追踪    │  │  配置中心    │          │
│  │  (8858)      │  │  (8080)      │  │  (8848)      │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

### 服务拓扑图

```
                    ┌─────────────┐
                    │   Gateway   │
                    │   (8080)    │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐       ┌─────▼─────┐     ┌─────▼─────┐
   │ Order   │       │Equipment  │     │ Quality   │
   │Service  │       │ Service   │     │ Service   │
   │ (8081)  │       │  (8083)   │     │  (8085)   │
   └────┬────┘       └───────────┘     └─────┬─────┘
        │                                     │
   ┌────▼────────┐                      ┌────▼────┐
   │Production   │◄─────────────────────┤ Order   │
   │  Service    │                      │ Service │
   │  (8082)     │                      └─────────┘
   └──┬──────┬───┘
      │      │
┌─────▼──┐ ┌▼────────┐
│Inventory│ │Equipment│
│Service  │ │Service  │
│ (8084)  │ │ (8083)  │
└─────────┘ └─────────┘
```

---

## 微服务拆分设计

### 1. API 网关服务 (Gateway)
**端口：** 8080  
**职责：**
- 统一入口，路由转发
- 负载均衡
- 限流熔断
- 跨域处理
- 认证鉴权（预留）

**技术栈：**
- Spring Cloud Gateway
- Sentinel (限流熔断)
- Nacos Discovery

---

### 2. 订单管理服务 (Order Service)
**端口：** 8081  
**数据库：** smart_manufact_order

**核心功能：**
- 订单创建、查询、更新、取消
- 订单优先级调度
- 触发生产计划
- 订单状态管理

**业务实体：**
- Order（订单）

**RESTful API：**
```
POST   /order/create              # 创建订单
GET    /order/{id}                # 查询订单
GET    /order/list                # 订单列表
PUT    /order/{id}/status         # 更新订单状态
DELETE /order/{id}                # 取消订单
POST   /order/{id}/trigger-production  # 触发生产
```

**服务依赖：**
- 调用 Production Service（触发排产）

---

### 3. 生产计划服务 (Production Service)
**端口：** 8082  
**数据库：** smart_manufact_production

**核心功能：**
- 生成主生产计划（MPS）
- 物料需求计划（MRP）
- 产能分析
- 排产优化
- 协调多车间生产节奏

**业务实体：**
- ProductionPlan（生产计划）

**RESTful API：**
```
POST   /production/plan/create    # 创建生产计划
GET    /production/plan/{planId}  # 查询生产计划
GET    /production/plan/list      # 生产计划列表
PUT    /production/plan/{planId}/status  # 更新计划状态
```

**服务依赖：**
- 调用 Inventory Service（检查物料可用性）
- 调用 Equipment Service（检查设备可用性）

---

### 4. 设备监控服务 (Equipment Service)
**端口：** 8083  
**数据库：** smart_manufact_equipment

**核心功能：**
- 实时采集设备运行数据
- 监控设备状态（OEE）
- 预测性维护
- 设备可用性检查

**业务实体：**
- Equipment（设备）

**RESTful API：**
```
GET    /equipment/list            # 设备列表
GET    /equipment/{id}            # 查询设备详情
GET    /equipment/{id}/status     # 查询设备状态
POST   /equipment/check-availability  # 检查设备可用性
PUT    /equipment/{id}/status     # 更新设备状态
```

**设备类型：**
- STAMPING（冲压机）
- WELDING（焊接机器人）
- PAINTING（涂装设备）
- ASSEMBLY（装配线）

---

### 5. 库存管理服务 (Inventory Service)
**端口：** 8084  
**数据库：** smart_manufact_inventory

**核心功能：**
- 原材料库存管理
- 半成品库存管理
- 成品库存管理
- 入库、出库、调拨、盘点
- JIT（准时制）供应链管理

**业务实体：**
- Inventory（库存）

**RESTful API：**
```
GET    /inventory/list            # 库存列表
GET    /inventory/{id}            # 查询库存详情
POST   /inventory/check           # 检查物料可用性
PUT    /inventory/{id}/quantity   # 更新库存数量
```

**物料类型：**
- RAW_MATERIAL（原材料：钢板、零部件）
- SEMI_FINISHED（半成品：车身、底盘）
- FINISHED（成品：整车）

---

### 6. 质量管理服务 (Quality Service)
**端口：** 8085  
**数据库：** smart_manufact_quality

**核心功能：**
- 质量检验记录
- 质量问题追溯
- 缺陷分析
- 质量预警

**业务实体：**
- QualityInspection（质量检验）

**RESTful API：**
```
GET    /quality/inspection/list   # 检验记录列表
GET    /quality/inspection/{id}   # 查询检验详情
POST   /quality/inspection/create # 创建检验记录
```

**检验类型：**
- STAMPING（冲压件检验）
- WELDING（焊接质量检测）
- PAINTING（涂装厚度测量）
- ROAD_TEST（整车路试）

---

## 技术选型

### 核心框架
| 技术 | 版本 | 说明 |
|------|------|------|
| Spring Boot | 3.0.2 | 微服务基础框架 |
| Spring Cloud | 2022.0.0 | 微服务治理 |
| Spring Cloud Alibaba | 2022.0.0.0 | 阿里巴巴微服务组件 |

### 服务治理
| 技术 | 版本 | 说明 |
|------|------|------|
| Nacos | 2.2.1 | 服务注册与配置中心 |
| Sentinel | 1.8.6 | 流量控制与熔断降级 |
| OpenFeign | - | 服务间调用 |
| LoadBalancer | - | 客户端负载均衡 |

### 链路追踪
| 技术 | 版本 | 说明 |
|------|------|------|
| Apache SkyWalking | 9.5.0 | 分布式链路追踪 |

### 数据持久化
| 技术 | 版本 | 说明 |
|------|------|------|
| MySQL | 8.0 | 关系型数据库 |
| MyBatis Plus | 3.5.3.1 | ORM 框架 |
| Druid | 1.2.16 | 数据库连接池 |

### 工具库
| 技术 | 版本 | 说明 |
|------|------|------|
| Lombok | 1.18.30 | 简化 Java 代码 |
| Hutool | 5.8.15 | Java 工具类库 |
| FastJson2 | 2.0.25 | JSON 处理 |

---

## 服务调用关系

### 场景1：订单下达流程

```
用户请求
  │
  ▼
Gateway (路由转发)
  │
  ▼
Order Service
  │ 1. 创建订单
  │ 2. 确认订单
  │ 3. 触发生产
  ▼
Production Service
  │ 1. 检查库存
  ├──────────────► Inventory Service
  │                  └─► 返回库存可用性
  │ 2. 检查设备
  ├──────────────► Equipment Service
  │                  └─► 返回设备可用性
  │ 3. 创建生产计划
  ▼
返回生产计划ID
```

### 场景2：质量问题追溯流程

```
用户请求
  │
  ▼
Gateway
  │
  ▼
Quality Service
  │ 1. 查询质量检验记录
  │ 2. 追溯到订单
  ├──────────────► Order Service
  │                  │
  │                  ▼
  │                Production Service
  │                  │
  │                  ▼
  │                Equipment Service
  ▼
返回完整追溯链路
```

### 场景3：设备异常处理流程

```
设备异常告警
  │
  ▼
Equipment Service
  │ 1. 更新设备状态
  │ 2. 通知生产计划
  ├──────────────► Production Service
  │                  │ 1. 暂停相关计划
  │                  │ 2. 通知订单服务
  │                  ▼
  │                Order Service
  │                  └─► 更新订单状态
  ▼
返回处理结果
```

---

## 数据库设计

### 数据库隔离策略
每个微服务拥有独立的数据库，实现数据隔离：

```
smart_manufact_order       # 订单服务数据库
smart_manufact_production  # 生产计划服务数据库
smart_manufact_equipment   # 设备监控服务数据库
smart_manufact_inventory   # 库存管理服务数据库
smart_manufact_quality     # 质量管理服务数据库
```

### 核心表结构

**订单表 (t_order)**
```sql
- id: 主键
- order_no: 订单号（唯一）
- customer_name: 客户名称
- customer_type: 客户类型
- vehicle_model: 车型
- quantity: 数量
- priority: 优先级
- status: 订单状态
- production_plan_id: 生产计划ID
```

**生产计划表 (t_production_plan)**
```sql
- id: 主键
- plan_id: 计划ID（唯一）
- order_id: 订单ID
- vehicle_model: 车型
- quantity: 生产数量
- status: 计划状态
- workshop_code: 车间编号
```

**设备表 (t_equipment)**
```sql
- id: 主键
- equipment_code: 设备编号（唯一）
- equipment_name: 设备名称
- equipment_type: 设备类型
- status: 设备状态
- oee: 设备综合效率
```

**库存表 (t_inventory)**
```sql
- id: 主键
- material_code: 物料编号（唯一）
- material_name: 物料名称
- material_type: 物料类型
- quantity: 库存数量
- safety_stock: 安全库存
```

**质量检验表 (t_quality_inspection)**
```sql
- id: 主键
- inspection_no: 检验单号（唯一）
- order_id: 订单ID
- inspection_type: 检验类型
- status: 检验状态
- quality_score: 质量评分
```

---

## 部署架构

### 开发环境部署

```
┌─────────────────────────────────────────┐
│               开发机                     │
│                                          │
│  ┌────────────────────────────────────┐ │
│  │  基础服务                           │ │
│  │  - MySQL (3306)                    │ │
│  │  - Nacos (8848)                    │ │
│  │  - Sentinel Dashboard (8858)       │ │
│  │  - SkyWalking (8080/11800)         │ │
│  └────────────────────────────────────┘ │
│                                          │
│  ┌────────────────────────────────────┐ │
│  │  微服务应用                         │ │
│  │  - Gateway (8080)                  │ │
│  │  - Order Service (8081)            │ │
│  │  - Production Service (8082)       │ │
│  │  - Equipment Service (8083)        │ │
│  │  - Inventory Service (8084)        │ │
│  │  - Quality Service (8085)          │ │
│  └────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 生产环境部署（推荐）

```
┌─────────────────────────────────────────────────────────┐
│                    负载均衡器 (Nginx)                     │
└────────────────────┬────────────────────────────────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
   ┌────▼───┐   ┌───▼────┐  ┌───▼────┐
   │Gateway │   │Gateway │  │Gateway │
   │  实例1 │   │  实例2 │  │  实例3 │
   └────┬───┘   └───┬────┘  └───┬────┘
        │           │           │
        └───────────┼───────────┘
                    │
    ┌───────────────┼───────────────┐
    │               │               │
┌───▼────┐     ┌───▼────┐     ┌───▼────┐
│ Order  │     │ Prod   │     │ Equip  │
│ 集群   │     │ 集群   │     │ 集群   │
└───┬────┘     └───┬────┘     └───┬────┘
    │              │              │
┌───▼──────────────▼──────────────▼────┐
│         Nacos 集群 (3节点)            │
└───────────────────────────────────────┘
    │              │              │
┌───▼────┐     ┌───▼────┐     ┌───▼────┐
│ MySQL  │     │ MySQL  │     │ MySQL  │
│ 主库   │────►│ 从库1  │     │ 从库2  │
└────────┘     └────────┘     └────────┘
```

---

## 扩展性设计

### 1. 水平扩展
- 所有微服务支持多实例部署
- 通过 Nacos 实现服务发现和负载均衡
- 数据库支持读写分离和分库分表

### 2. 垂直扩展
- 预留接口支持新增服务
- 如：物流服务、供应商协同服务、财务服务等

### 3. 容错设计
- Sentinel 熔断降级
- Feign 超时重试
- 数据库连接池

### 4. 监控告警
- SkyWalking 链路追踪
- Sentinel 实时监控
- 日志集成（预留 ELK）


